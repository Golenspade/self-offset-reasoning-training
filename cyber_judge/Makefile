# èµ›åšè£åˆ¤é•¿ - Makefile

.PHONY: help install crawl clean distill run-bot test venv

# è™šæ‹Ÿç¯å¢ƒè·¯å¾„
VENV := .venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip

help:
	@echo "èµ›åšè£åˆ¤é•¿ - å¯ç”¨å‘½ä»¤:"
	@echo "  make venv           - åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"
	@echo "  make install        - å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼‰"
	@echo "  make install-browser - å®‰è£… Playwright æµè§ˆå™¨"
	@echo "  make crawl          - è¿è¡Œçˆ¬è™«æŠ“å–æ•°æ® (Go ç‰ˆæœ¬)"
	@echo "  make crawl-pw       - è¿è¡Œ Playwright çˆ¬è™« (æ¨è)"
	@echo "  make clean          - æ¸…æ´—æ•°æ®"
	@echo "  make distill        - LLM è’¸é¦æ•°æ®"
	@echo "  make run-bot        - å¯åŠ¨ Bot"
	@echo "  make test           - è¿è¡Œæµ‹è¯•"
	@echo "  make all            - å®Œæ•´æµç¨‹ï¼ˆçˆ¬è™«->æ¸…æ´—->è’¸é¦ï¼‰"

venv:
	@echo "ğŸ”§ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
	@if command -v uv >/dev/null 2>&1; then \
		echo "âœ¨ ä½¿ç”¨ uv åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."; \
		uv venv $(VENV); \
	else \
		echo "ğŸ“¦ ä½¿ç”¨ python3 -m venv åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."; \
		python3 -m venv $(VENV); \
	fi
	@echo "âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ: $(VENV)"

install: venv
	@echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
	@if command -v uv >/dev/null 2>&1; then \
		echo "âœ¨ ä½¿ç”¨ uv å®‰è£…ä¾èµ–ï¼ˆæé€Ÿï¼‰..."; \
		uv pip install -r requirements.txt; \
	else \
		echo "ğŸ“¦ ä½¿ç”¨ pip å®‰è£…ä¾èµ–..."; \
		$(PIP) install --upgrade pip; \
		$(PIP) install -r requirements.txt; \
	fi
	@echo "ğŸ“¦ å®‰è£… Go ä¾èµ–..."
	cd harvester && go mod download
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
	@echo ""
	@echo "ğŸ’¡ æç¤º: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ:"
	@echo "   source $(VENV)/bin/activate"

crawl:
	@echo "ğŸ•·ï¸  å¯åŠ¨çˆ¬è™« (Go ç‰ˆæœ¬)..."
	cd harvester && go run main.go

crawl-pw:
	@echo "ğŸ­ å¯åŠ¨ Playwright çˆ¬è™«..."
	$(PYTHON) harvester/crawler_playwright.py

crawl-interactive:
	@echo "ğŸ­ å¯åŠ¨äº¤äº’å¼çˆ¬è™«ï¼ˆéœ€è¦æ‰‹åŠ¨å®ŒæˆéªŒè¯ï¼‰..."
	$(PYTHON) harvester/interactive_crawler.py

crawl-bandori:
	@echo "ğŸ¯ æ·±åº¦çˆ¬å–é‚¦å¤šåˆ©æ€€å­•å§ï¼ˆåŒ…å«å›å¤ï¼‰..."
	$(PYTHON) harvester/crawl_bandori_deep.py

install-browser:
	@echo "ğŸ“¦ å®‰è£… Playwright æµè§ˆå™¨..."
	$(VENV)/bin/playwright install chromium

clean:
	@echo "ğŸ§¹ æ¸…æ´—æ•°æ®..."
	$(PYTHON) refinery/cleaner.py

distill:
	@echo "ğŸ§ª è’¸é¦æ•°æ®..."
	$(PYTHON) refinery/distiller.py

run-bot:
	@echo "ğŸ¤– å¯åŠ¨èµ›åšè£åˆ¤é•¿..."
	cd body && $(PYTHON) bot.py

test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	$(VENV)/bin/pytest tests/ -v

all: crawl clean distill
	@echo "âœ… æ•°æ®å‡†å¤‡å®Œæˆï¼ç°åœ¨å¯ä»¥è¿è¡Œ make run-bot å¯åŠ¨ Bot"

# å¼€å‘ç›¸å…³
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	$(VENV)/bin/black .
	cd harvester && go fmt ./...

lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	$(VENV)/bin/flake8 .
	cd harvester && go vet ./...

# æ¸…ç†
clean-data:
	@echo "ğŸ—‘ï¸  æ¸…ç†æ•°æ®..."
	rm -rf data/raw/*
	rm -rf data/processed/*

clean-venv:
	@echo "ğŸ—‘ï¸  æ¸…ç†è™šæ‹Ÿç¯å¢ƒ..."
	rm -rf $(VENV)

clean-all: clean-data clean-venv
	@echo "ğŸ—‘ï¸  æ¸…ç†æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶..."
	rm -rf data/memory.db
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

